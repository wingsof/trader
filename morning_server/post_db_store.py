from morning_server import message
from configs import db
from morning.back_data.holidays import is_holidays, get_working_days, get_yesterday
from pymongo import MongoClient
from datetime import date, timedelta, datetime
from utils import time_converter


def store_uni_data(code, body):
    stock_db = MongoClient(db.HOME_MONGO_ADDRESS)['stock']
    start_date = body[0]['0']
    end_date = body[-1]['0']
    db_data = list(stock_db[code + message.UNI_DAY_SUFFIX].find({'0': {'$gte': start_date, '$lte': end_date}}))
    if len(db_data) == len(body):
        pass
    elif len(db_data) == 0:
        stock_db[code + message.UNI_DAY_SUFFIX].insert_many(body)
    else:
        db_dates = [d['0'] for d in db_data]

        for d in body:
            if d['0'] not in db_dates:
                stock_db[code + message.UNI_DAY_SUFFIX].insert_one(d)


def store_uni_current_data(code, data):
    stock_db = MongoClient(db.HOME_MONGO_ADDRESS)['stock']
    data_date = data['27']
    data_time = data['2']
    db_data = list(stock_db[code + message.UNI_CURRENT_SUFFIX].find({'27': data_date}))
    if len(db_data) == 0:
        stock_db[code + message.UNI_CURRENT_SUFFIX].insert_one(data)
    elif len(db_data) == 1 and db_data[0]['27'] == data_date and db_data[0]['2'] == data_time:
        pass
    else:
        stock_db[code + message.UNI_CURRENT_SUFFIX].remove({'27': data_date})
        # assume that current data is latest one
        stock_db[code + message.UNI_CURRENT_SUFFIX].insert_one(data)


def check_post_store_data(header, body):
    if header['method'] == message.UNI_DATA:
        if len(body) > 0:
            store_uni_data(header['code'], body)
    elif header['method'] == message.UNI_CURRENT_DATA:
        if len(body) == 1:
            store_uni_current_data(header['code'], body[0])


def query_uni_period_data(code, from_date, until_date):
    stock_db = MongoClient(db.HOME_MONGO_ADDRESS)['stock']
    query = {'$gte': time_converter.datetime_to_intdate(from_date),
            '$lte': time_converter.datetime_to_intdate(until_date)}
    db_data = list(stock_db[code + message.UNI_DAY_SUFFIX].find({'0': query}))
    return db_data


def query_uni_current_period_data(code, from_date, until_date):
    stock_db = MongoClient(db.HOME_MONGO_ADDRESS)['stock']
    query = {'$gte': time_converter.datetime_to_intdate(from_date),
            '$lte': time_converter.datetime_to_intdate(until_date)}
    db_data = list(stock_db[code + message.UNI_CURRENT_SUFFIX].find({'27': query}))
    return db_data


# [{'0': 'A005930', '1': '삼성전자', '2': 180020, '3': 1100, '4': '', '5': 0, '6': 62800, '7': 20200120, '8': 42300, '9': 20200319, '10': 57900, '11': 57900, '12': 53, '13': 50, '14': 100, '15': 58000, '16': 57900, '17': 58100, '18': 57900, '19': 63600, '20': 52200, '21': 58100, '22': 58000, '23': 0, '24': 0, '25': 75893, '26': 440064, '27': 20200731, '28': 50, '29': 50, '30': 100, '31': 58000, '32': 10094, '33': 58100, '34': 58000, '35': 8050, '36': 10622, '37': 0, '38': '021', '39': 2917463, '40': '021', '41': 2734375, '42': '086', '43': 2553977, '44': '086', '45': 2494127, '46': '030', '47': 1734883, '48': '030', '49': 1792999, '50': '035', '51': 1486058, '52': '005', '53': 1739760, '54': '005', '55': 1337910, '56': '043', '57': 1659506, '58': 58100, '59': 8000, '60': 0, '61': 58000, '62': 10622, '63': 0, '64': 58200, '65': 8523, '66': 0, '67': 57900, '68': 14290, '69': 0, '70': 58300, '71': 13036, '72': 0, '73': 57800, '74': 11055, '75': 0, '76': 58400, '77': 1186, '78': 0, '79': 57700, '80': 4240, '81': 0, '82': 58500, '83': 3107, '84': 0, '85': 57600, '86': 1262, '87': 0, '88': 42371, '89': 42371, '90': 45727, '91': 45727, '92': '거래소', '93': '대형', '94': 59500, '95': 59600, '96': 57700, '97': 100, '98': 18.47, '99': '5969782', '100': '5969782', '101': '2627284', '102': '5969782', '103': 100.0, '104': 44.01, '105': 53, '106': 0, '107': 62800, '108': 20200120, '109': 42300, '110': 20200319, '111': 20200730, '112': 20200729, '113': 20200728, '114': 20200727, '115': 59700, '116': 60300, '117': 57000, '118': 54300, '119': 60100, '120': 60400, '121': 58800, '122': 55700, '123': 59000, '124': 58600, '125': 56400, '126': 54300, '127': 59000, '128': 59000, '129': 58600, '130': 55600, '131': 54200, '132': 54100, '133': 54700, '134': 55300, '135': 12, '136': 2106273, '137': -35135, '138': 162231}] http://cybosplus.github.io/cpsysdib_rtf_1_/stockunimst.htm



# [{'0': 20200612, '1': 52200, '2': 52700, '3': 52200, '4': 52700, '5': 400, '6': 0.76, '7': 50, '8': 163381}, {'0': 20200615, '1': 50200, '2': 50300, '3': 50000, '4': 50300, '5': 400, '6': 0.8, '7': 50, '8': 197955}, {'0': 20200616, '1': 51500, '2': 51500, '3': 51300, '4': 51300, '5': 800, '6': -1.58, '7': 53, '8': 383642}, {'0': 20200617, '1': 52300, '2': 52400, '3': 52200, '4': 52400, '5': 200, '6': 0.38, '7': 50, '8': 80190}, {'0': 20200618, '1': 52200, '2': 52300, '3': 52100, '4': 52300, '5': 0, '6': 0.0, '7': 51, '8': 92317}, {'0': 20200619, '1': 52800, '2': 52800, '3': 52800, '4': 52800, '5': 100, '6': -0.19, '7': 53, '8': 66639}, {'0': 20200622, '1': 52100, '2': 52300, '3': 52100, '4': 52300, '5': 300, '6': 0.58, '7': 50, '8': 53135}, {'0': 20200623, '1': 51700, '2': 51800, '3': 51700, '4': 51800, '5': 400, '6': 0.78, '7': 50, '8': 126505}, {'0': 20200624, '1': 53100, '2': 53100, '3': 52600, '4': 52700, '5': 200, '6': -0.38, '7': 53, '8': 127872}, {'0': 20200625, '1': 51900, '2': 52200, '3': 51800, '4': 52200, '5': 300, '6': 0.58, '7': 50, '8': 105456}, {'0': 20200626, '1': 53400, '2': 53400, '3': 53200, '4': 53300, '5': 0, '6': 0.0, '7': 51, '8': 81731}, {'0': 20200629, '1': 52500, '2': 52600, '3': 52500, '4': 52500, '5': 100, '6': 0.19, '7': 50, '8': 53967}, {'0': 20200630, '1': 52900, '2': 53000, '3': 52800, '4': 53000, '5': 200, '6': 0.38, '7': 50, '8': 72538}, {'0': 20200701, '1': 52700, '2': 52800, '3': 52700, '4': 52800, '5': 200, '6': 0.38, '7': 50, '8': 77073}, {'0': 20200702, '1': 52900, '2': 53200, '3': 52800, '4': 53100, '5': 200, '6': 0.38, '7': 50, '8': 103628}, {'0': 20200703, '1': 53700, '2': 53700, '3': 53500, '4': 53500, '5': 100, '6': -0.19, '7': 53, '8': 65671}, {'0': 20200706, '1': 55000, '2': 55300, '3': 54900, '4': 55300, '5': 300, '6': 0.55, '7': 50, '8': 130982}, {'0': 20200707, '1': 53500, '2': 53500, '3': 53400, '4': 53500, '5': 100, '6': 0.19, '7': 50, '8': 122651}, {'0': 20200708, '1': 53000, '2': 53300, '3': 53000, '4': 53200, '5': 200, '6': 0.38, '7': 50, '8': 137032}, {'0': 20200709, '1': 53000, '2': 53100, '3': 53000, '4': 53000, '5': 200, '6': 0.38, '7': 50, '8': 127180}, {'0': 20200710, '1': 52700, '2': 52800, '3': 52700, '4': 52800, '5': 100, '6': 0.19, '7': 50, '8': 56416}, {'0': 20200713, '1': 53600, '2': 53600, '3': 53500, '4': 53600, '5': 200, '6': 0.37, '7': 50, '8': 45982}, {'0': 20200714, '1': 53800, '2': 53800, '3': 53600, '4': 53800, '5': 0, '6': 0.0, '7': 51, '8': 47484}, {'0': 20200715, '1': 54800, '2': 54900, '3': 54800, '4': 54900, '5': 200, '6': 0.37, '7': 50, '8': 59366}, {'0': 20200716, '1': 53900, '2': 53900, '3': 53600, '4': 53600, '5': 200, '6': -0.37, '7': 53, '8': 74158}, {'0': 20200717, '1': 54500, '2': 54600, '3': 54400, '4': 54500, '5': 100, '6': 0.18, '7': 50, '8': 52699}, {'0': 20200720, '1': 54300, '2': 54500, '3': 54200, '4': 54500, '5': 300, '6': 0.55, '7': 50, '8': 27728}, {'0': 20200721, '1': 55300, '2': 55500, '3': 55300, '4': 55500, '5': 200, '6': 0.36, '7': 50, '8': 75806}, {'0': 20200722, '1': 54900, '2': 54900, '3': 54700, '4': 54700, '5': 0, '6': 0.0, '7': 51, '8': 55102}, {'0': 20200723, '1': 54200, '2': 54300, '3': 54100, '4': 54300, '5': 200, '6': 0.37, '7': 50, '8': 54044}, {'0': 20200724, '1': 54000, '2': 54000, '3': 53900, '4': 54000, '5': 200, '6': -0.37, '7': 53, '8': 89287}, {'0': 20200727, '1': 55600, '2': 55600, '3': 55500, '4': 55600, '5': 0, '6': 0.0, '7': 51, '8': 66097}, {'0': 20200728, '1': 58600, '2': 58600, '3': 58500, '4': 58600, '5': 0, '6': 0.0, '7': 51, '8': 152470}, {'0': 20200729, '1': 59200, '2': 59300, '3': 59100, '4': 59300, '5': 300, '6': 0.51, '7': 50, '8': 58525}, {'0': 20200730, '1': 59000, '2': 59000, '3': 58700, '4': 58700, '5': 300, '6': -0.51, '7': 53, '8': 93180}, {'0': 20200731, '1': 57900, '2': 58100, '3': 57900, '4': 58000, '5': 100, '6': 0.17, '7': 50, '8': 75893}]
